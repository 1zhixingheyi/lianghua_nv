#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç»Ÿä¸€é…ç½®ç³»ç»Ÿæµ‹è¯•è„šæœ¬

æµ‹è¯•é¡¹ç›®:
1. é…ç½®æ¨¡å—å¯¼å…¥æµ‹è¯•
2. é…ç½®æ–‡ä»¶åŠ è½½æµ‹è¯•
3. é…ç½®è®¿é—®APIæµ‹è¯•
4. çŽ¯å¢ƒå˜é‡æ›¿æ¢æµ‹è¯•
5. é…ç½®éªŒè¯æµ‹è¯•
6. å‘åŽå…¼å®¹æ€§æµ‹è¯•

ä½œè€…: QuantTeam
åˆ›å»ºæ—¶é—´: 2025-01-19
"""

import os
import sys
import traceback
from datetime import datetime

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
project_root = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, project_root)

def test_config_module_import():
    """æµ‹è¯•é…ç½®æ¨¡å—å¯¼å…¥"""
    try:
        # æµ‹è¯•åŸºæœ¬å¯¼å…¥
        from quant_system.config import (
            ConfigManager,
            DatabaseConfigManager,
            get_config,
            get_data_config,
            reload_config
        )
        
        # æµ‹è¯•æ•°æ®åº“é…ç½®å¯¼å…¥
        from quant_system.config.schemas.database_config import DatabaseConfig
        
        return True, "é…ç½®æ¨¡å—å¯¼å…¥æˆåŠŸ"
    except Exception as e:
        return False, f"é…ç½®æ¨¡å—å¯¼å…¥å¤±è´¥: {str(e)}\n{traceback.format_exc()}"

def test_config_file_loading():
    """æµ‹è¯•é…ç½®æ–‡ä»¶åŠ è½½"""
    try:
        from quant_system.config import config_manager, database_config_manager
        
        # æµ‹è¯•é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–
        if config_manager is None:
            return False, "é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥"
            
        if database_config_manager is None:
            return False, "æ•°æ®åº“é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥"
            
        # æµ‹è¯•æ•°æ®åº“é…ç½®åŠ è½½
        try:
            configs = database_config_manager.get_all_configs()
            if not configs:
                return False, "æ•°æ®åº“é…ç½®ä¸ºç©º"
        except Exception as e:
            return False, f"æ•°æ®åº“é…ç½®åŠ è½½å¤±è´¥: {str(e)}"
            
        return True, f"é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸï¼Œæ•°æ®åº“é…ç½®æ•°é‡: {len(configs)}"
    except Exception as e:
        return False, f"é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥: {str(e)}\n{traceback.format_exc()}"

def test_config_access_api():
    """æµ‹è¯•é…ç½®è®¿é—®API"""
    try:
        from quant_system.config import get_config, get_data_config, database_config_manager
        
        # æµ‹è¯•æ•°æ®åº“é…ç½®è®¿é—®
        try:
            main_config = database_config_manager.get_config('main')
            if main_config is None:
                return False, "æ— æ³•èŽ·å–ä¸»æ•°æ®åº“é…ç½®"
        except Exception as e:
            return False, f"æ•°æ®åº“é…ç½®è®¿é—®å¤±è´¥: {str(e)}"
            
        # æµ‹è¯•é€šç”¨é…ç½®è®¿é—®ï¼ˆå¯èƒ½ä¸ºç©ºï¼Œä½†ä¸åº”è¯¥æŠ¥é”™ï¼‰
        try:
            test_config = get_config('test.key', 'default_value')
            # åº”è¯¥è¿”å›žé»˜è®¤å€¼
            if test_config != 'default_value':
                return False, f"é…ç½®é»˜è®¤å€¼å¤„ç†å¼‚å¸¸: æœŸæœ› 'default_value'ï¼Œå®žé™… '{test_config}'"
        except Exception as e:
            return False, f"é€šç”¨é…ç½®è®¿é—®å¤±è´¥: {str(e)}"
            
        return True, "é…ç½®è®¿é—®APIæµ‹è¯•æˆåŠŸ"
    except Exception as e:
        return False, f"é…ç½®è®¿é—®APIæµ‹è¯•å¤±è´¥: {str(e)}\n{traceback.format_exc()}"

def test_environment_variable_replacement():
    """æµ‹è¯•çŽ¯å¢ƒå˜é‡æ›¿æ¢"""
    try:
        from quant_system.config import database_config_manager
        
        # è®¾ç½®æµ‹è¯•çŽ¯å¢ƒå˜é‡
        os.environ['TEST_MYSQL_HOST'] = 'test.example.com'
        os.environ['TEST_MYSQL_PORT'] = '3307'
        
        # é‡æ–°åŠ è½½é…ç½®ä»¥åº”ç”¨çŽ¯å¢ƒå˜é‡
        database_config_manager.reload_all()
        
        # æ£€æŸ¥çŽ¯å¢ƒå˜é‡æ˜¯å¦è¢«æ­£ç¡®åº”ç”¨
        # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬æ£€æŸ¥çš„æ˜¯é»˜è®¤é…ç½®ï¼Œå› ä¸ºæµ‹è¯•çŽ¯å¢ƒå˜é‡åä¸Žå®žé™…ä½¿ç”¨çš„ä¸åŒ
        main_config = database_config_manager.get_config('main')
        
        # æ¸…ç†æµ‹è¯•çŽ¯å¢ƒå˜é‡
        del os.environ['TEST_MYSQL_HOST']
        del os.environ['TEST_MYSQL_PORT']
        
        return True, "çŽ¯å¢ƒå˜é‡æ›¿æ¢æµ‹è¯•æˆåŠŸ"
    except Exception as e:
        return False, f"çŽ¯å¢ƒå˜é‡æ›¿æ¢æµ‹è¯•å¤±è´¥: {str(e)}\n{traceback.format_exc()}"

def test_config_validation():
    """æµ‹è¯•é…ç½®éªŒè¯"""
    try:
        from quant_system.config import database_config_manager
        
        # æµ‹è¯•é…ç½®éªŒè¯
        validation_results = []
        configs = database_config_manager.get_all_configs()
        
        for name in configs.keys():
            try:
                is_valid = database_config_manager.validate_config(name)
                validation_results.append((name, is_valid))
            except Exception as e:
                validation_results.append((name, False))
                
        valid_count = sum(1 for _, is_valid in validation_results if is_valid)
        total_count = len(validation_results)
        
        return True, f"é…ç½®éªŒè¯å®Œæˆ: {valid_count}/{total_count} ä¸ªé…ç½®æœ‰æ•ˆ"
    except Exception as e:
        return False, f"é…ç½®éªŒè¯æµ‹è¯•å¤±è´¥: {str(e)}\n{traceback.format_exc()}"

def test_backward_compatibility():
    """æµ‹è¯•å‘åŽå…¼å®¹æ€§"""
    try:
        # æµ‹è¯•æ˜¯å¦å¯ä»¥å¯¼å…¥æ—§çš„é…ç½®æ¨¡å—ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
        try:
            # è¿™ä¸ªå¯¼å…¥å¯èƒ½ä¼šå¤±è´¥ï¼Œè¿™æ˜¯æ­£å¸¸çš„
            from quant_system.DATA.core.config_manager import ConfigManager as OldConfigManager
            old_config_available = True
        except ImportError:
            old_config_available = False
            
        # æµ‹è¯•æ–°é…ç½®ç³»ç»Ÿçš„å…¼å®¹æ€§æŽ¥å£
        from quant_system.config import reload_config, load_all_configs
        
        # æµ‹è¯•é‡æ–°åŠ è½½åŠŸèƒ½
        reload_config()
        load_all_configs()
        
        compatibility_info = f"æ—§é…ç½®ç³»ç»Ÿå¯ç”¨: {old_config_available}"
        return True, f"å‘åŽå…¼å®¹æ€§æµ‹è¯•æˆåŠŸ - {compatibility_info}"
    except Exception as e:
        return False, f"å‘åŽå…¼å®¹æ€§æµ‹è¯•å¤±è´¥: {str(e)}\n{traceback.format_exc()}"

def run_all_tests():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    tests = [
        ("é…ç½®æ¨¡å—å¯¼å…¥", test_config_module_import),
        ("é…ç½®æ–‡ä»¶åŠ è½½", test_config_file_loading),
        ("é…ç½®è®¿é—®API", test_config_access_api),
        ("çŽ¯å¢ƒå˜é‡æ›¿æ¢", test_environment_variable_replacement),
        ("é…ç½®éªŒè¯", test_config_validation),
        ("å‘åŽå…¼å®¹æ€§", test_backward_compatibility),
    ]
    
    results = []
    passed = 0
    total = len(tests)
    
    print("=== ç»Ÿä¸€é…ç½®ç³»ç»Ÿæµ‹è¯•å¼€å§‹ ===")
    print(f"æµ‹è¯•æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"Pythonç‰ˆæœ¬: {sys.version}")
    print(f"é¡¹ç›®è·¯å¾„: {project_root}")
    print()
    
    for test_name, test_func in tests:
        print(f"è¿è¡Œæµ‹è¯•: {test_name}...")
        try:
            success, message = test_func()
            if success:
                print(f"âœ“ {test_name}: é€šè¿‡")
                print(f"  è¯¦æƒ…: {message}")
                passed += 1
            else:
                print(f"âœ— {test_name}: å¤±è´¥")
                print(f"  é”™è¯¯: {message}")
            results.append((test_name, success, message))
        except Exception as e:
            error_msg = f"æµ‹è¯•æ‰§è¡Œå¼‚å¸¸: {str(e)}\n{traceback.format_exc()}"
            print(f"âœ— {test_name}: å¼‚å¸¸")
            print(f"  é”™è¯¯: {error_msg}")
            results.append((test_name, False, error_msg))
        print()
    
    # ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
    success_rate = (passed / total) * 100
    print("=== æµ‹è¯•ç»“æžœæ±‡æ€» ===")
    print(f"æ€»æµ‹è¯•æ•°: {total}")
    print(f"é€šè¿‡æ•°: {passed}")
    print(f"å¤±è´¥æ•°: {total - passed}")
    print(f"æˆåŠŸçŽ‡: {success_rate:.1f}%")
    
    if success_rate >= 80:
        print("\nðŸŽ‰ ç»Ÿä¸€é…ç½®ç³»ç»ŸåŸºæœ¬æ­£å¸¸ï¼")
    elif success_rate >= 50:
        print("\nâš ï¸  ç»Ÿä¸€é…ç½®ç³»ç»Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œéœ€è¦ä¿®å¤ã€‚")
    else:
        print("\nâŒ ç»Ÿä¸€é…ç½®ç³»ç»Ÿå­˜åœ¨ä¸¥é‡é—®é¢˜ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨ã€‚")
    
    # å†™å…¥è¯¦ç»†æŠ¥å‘Š
    report_content = f"""ç»Ÿä¸€é…ç½®ç³»ç»Ÿæµ‹è¯•æŠ¥å‘Š
ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
Pythonç‰ˆæœ¬: {sys.version}
é¡¹ç›®è·¯å¾„: {project_root}

æµ‹è¯•ç»“æžœæ±‡æ€»:
æ€»æµ‹è¯•æ•°: {total}
é€šè¿‡æ•°: {passed}
å¤±è´¥æ•°: {total - passed}
æˆåŠŸçŽ‡: {success_rate:.1f}%

è¯¦ç»†æµ‹è¯•ç»“æžœ:
"""
    
    for test_name, success, message in results:
        status = "é€šè¿‡" if success else "å¤±è´¥"
        report_content += f"\n{test_name}: {status}\n"
        report_content += f"è¯¦æƒ…: {message}\n"
        report_content += "-" * 50 + "\n"
    
    try:
        with open('config_test_report.txt', 'w', encoding='utf-8') as f:
            f.write(report_content)
        print(f"\nè¯¦ç»†æŠ¥å‘Šå·²ä¿å­˜åˆ°: config_test_report.txt")
    except Exception as e:
        print(f"\næŠ¥å‘Šä¿å­˜å¤±è´¥: {e}")
    
    return success_rate >= 80

if __name__ == "__main__":
    try:
        success = run_all_tests()
        sys.exit(0 if success else 1)
    except Exception as e:
        print(f"æµ‹è¯•è„šæœ¬æ‰§è¡Œå¤±è´¥: {e}")
        print(traceback.format_exc())
        sys.exit(1)