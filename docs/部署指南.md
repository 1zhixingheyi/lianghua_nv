# 量化交易系统部署指南

## 📋 部署概述

本指南详细介绍了量化交易系统在不同环境下的部署方法，包括开发环境、测试环境和生产环境的完整部署流程。

## 🎯 部署环境

### 支持的部署方式

1. **本地开发部署** - 适用于开发调试
2. **Docker容器部署** - 适用于测试和生产
3. **云服务器部署** - 适用于生产环境
4. **集群部署** - 适用于高可用生产环境

### 系统要求

#### 最低配置
- **CPU**: 2核心
- **内存**: 4GB
- **存储**: 20GB可用空间
- **操作系统**: Ubuntu 18.04+, CentOS 7+, Windows 10+

#### 推荐配置
- **CPU**: 4核心
- **内存**: 8GB
- **存储**: 100GB SSD
- **网络**: 100Mbps带宽

#### 生产环境配置
- **CPU**: 8核心
- **内存**: 16GB
- **存储**: 500GB SSD
- **网络**: 1Gbps带宽

## 🛠️ 环境准备

### 1. 系统环境配置

#### Ubuntu/Debian系统
```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装必要工具
sudo apt install -y git curl wget vim htop

# 安装Python 3.8+
sudo apt install -y python3.8 python3.8-pip python3.8-venv

# 安装数据库
sudo apt install -y mysql-server redis-server

# 启动服务
sudo systemctl start mysql redis-server
sudo systemctl enable mysql redis-server
```

#### CentOS/RHEL系统
```bash
# 更新系统包
sudo yum update -y

# 安装必要工具
sudo yum install -y git curl wget vim htop

# 安装Python 3.8+
sudo yum install -y python38 python38-pip

# 安装数据库
sudo yum install -y mysql-server redis

# 启动服务
sudo systemctl start mysqld redis
sudo systemctl enable mysqld redis
```

#### Windows系统
1. 安装Python 3.8+ (https://python.org)
2. 安装Git (https://git-scm.com)
3. 安装MySQL (https://mysql.com)
4. 安装Redis (https://redis.io)

### 2. 数据库配置

#### MySQL配置
```bash
# 安全初始化
sudo mysql_secure_installation

# 创建数据库
mysql -u root -p
```

```sql
CREATE DATABASE lianghua_trading CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'lianghua'@'localhost' IDENTIFIED BY 'strong_password';
GRANT ALL PRIVILEGES ON lianghua_trading.* TO 'lianghua'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

#### Redis配置
```bash
# 编辑Redis配置
sudo vim /etc/redis/redis.conf

# 修改以下配置
bind 127.0.0.1
port 6379
requirepass your_redis_password
maxmemory 1gb
maxmemory-policy allkeys-lru

# 重启Redis
sudo systemctl restart redis
```

## 🚀 本地开发部署

### 1. 获取源码

```bash
# 克隆仓库
git clone https://github.com/your-repo/lianghua_vn.git
cd lianghua_vn

# 切换到指定版本(可选)
git checkout v1.0.0
```

### 2. 创建虚拟环境

```bash
# 创建Python虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate     # Windows
```

### 3. 安装依赖

```bash
# 升级pip
pip install --upgrade pip

# 安装项目依赖
pip install -r requirements.txt

# 安装开发依赖(可选)
pip install -r requirements-dev.txt
```

### 4. 环境变量配置

系统采用企业级四层存储架构，需要配置完整的环境变量：

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑环境变量
vim .env
```

```bash
# .env文件内容 - 四层存储架构配置

# MySQL配置 (结构化数据层)
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=lianghua
MYSQL_PASSWORD=strong_password_here
MYSQL_DATABASE=lianghua_trading

# ClickHouse配置 (分析层)
CLICKHOUSE_HOST=localhost
CLICKHOUSE_PORT=9000
CLICKHOUSE_USER=default
CLICKHOUSE_PASSWORD=clickhouse_password
CLICKHOUSE_DATABASE=lianghua_analytics

# Redis配置 (缓存层)
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=redis_password_here
REDIS_DB=0

# MinIO配置 (对象存储层)
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=minio_access_key
MINIO_SECRET_KEY=minio_secret_key
MINIO_SECURE=false

# API配置
TUSHARE_TOKEN=your_tushare_token

# 系统配置
ENVIRONMENT=production
DEBUG_MODE=false
SECRET_KEY=your_secret_key_here
JWT_SECRET_KEY=your_jwt_secret_key

# QMT配置
QMT_PATH=/path/to/qmt

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=logs/app.log
```

### 5. 配置验证

```bash
# 验证配置完整性
python -c "
from config import config_manager
is_valid, errors = config_manager.validate()
if is_valid:
    print('✅ 配置验证通过')
else:
    print('❌ 配置验证失败:')
    for error in errors:
        print(f'  - {error}')
"

# 测试四层存储连接
python -c "
from config import get_mysql_config, get_redis_config
print('MySQL配置:', get_mysql_config()['database']['host'])
print('Redis配置:', get_redis_config()['connection']['host'])
"
```

### 5. 数据库初始化

```bash
# 创建数据库表
python -c "
from data.database import init_database
init_database()
print('数据库初始化完成')
"

# 导入初始数据(可选)
python scripts/import_initial_data.py
```

### 6. 启动服务

```bash
# 启动Web服务
python run_monitor.py

# 或者以调试模式启动
python run_monitor.py --debug

# 指定端口启动
python run_monitor.py --port 8080
```

### 7. 验证部署

```bash
# 检查服务状态
curl http://localhost:5000/health

# 运行系统测试
python run_tests.py

# 检查API接口
curl http://localhost:5000/api/dashboard/summary
```

## 🐳 Docker容器部署

### 1. Docker环境准备

```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker
```

### 2. 创建Dockerfile

```dockerfile
# Dockerfile
FROM python:3.8-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制项目文件
COPY . .

# 创建日志目录
RUN mkdir -p logs

# 设置环境变量
ENV PYTHONPATH=/app
ENV FLASK_APP=monitor.web_app:app

# 暴露端口
EXPOSE 5000

# 健康检查
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:5000/health || exit 1

# 启动命令
CMD ["python", "run_monitor.py", "--host", "0.0.0.0"]
```

### 3. 创建Docker Compose配置

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "5000:5000"
    environment:
      # 四层存储架构配置
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=lianghua
      - MYSQL_PASSWORD=password
      - MYSQL_DATABASE=lianghua_trading
      
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=9000
      - CLICKHOUSE_DATABASE=lianghua_analytics
      
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=password
      
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      
      # 系统配置
      - ENVIRONMENT=production
      - SECRET_KEY=your_secret_key_here
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
      - ./config:/app/config
    depends_on:
      - mysql
      - clickhouse
      - redis
      - minio
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=lianghua_trading
      - MYSQL_USER=lianghua
      - MYSQL_PASSWORD=password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: redis-server --requirepass password
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    restart: unless-stopped

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    environment:
      - CLICKHOUSE_DB=lianghua_analytics
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    ports:
      - "9000:9000"
      - "8123:8123"
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    environment:
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    command: server /data --console-address ":9001"
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - app
    restart: unless-stopped

volumes:
  mysql_data:
  clickhouse_data:
  redis_data:
  minio_data:
```

### 4. 创建Nginx配置

```nginx
# nginx/nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream app {
        server app:5000;
    }

    server {
        listen 80;
        server_name localhost;

        location / {
            proxy_pass http://app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /ws {
            proxy_pass http://app;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }
    }
}
```

### 5. 容器部署

```bash
# 构建和启动服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f app

# 停止服务
docker-compose down

# 重新构建
docker-compose up -d --build
```

## ☁️ 云服务器部署

### 1. 云服务器选择

#### 阿里云ECS
```bash
# 购买ECS实例
# 规格：ecs.c6.xlarge (4核8GB)
# 系统：Ubuntu 20.04 LTS
# 存储：100GB ESSD云盘
# 网络：专有网络VPC
```

#### 腾讯云CVM
```bash
# 购买CVM实例
# 规格：S5.LARGE8 (4核8GB)
# 系统：Ubuntu Server 20.04 LTS
# 存储：100GB高性能云硬盘
# 网络：私有网络VPC
```

#### AWS EC2
```bash
# 启动EC2实例
# 实例类型：t3.large (2核8GB)
# AMI：Ubuntu Server 20.04 LTS
# 存储：100GB gp3
# 网络：VPC
```

### 2. 服务器初始配置

```bash
# 连接到服务器
ssh -i your-key.pem ubuntu@server-ip

# 更新系统
sudo apt update && sudo apt upgrade -y

# 创建应用用户
sudo useradd -m -s /bin/bash lianghua
sudo usermod -aG sudo lianghua

# 配置SSH密钥
sudo mkdir -p /home/lianghua/.ssh
sudo cp ~/.ssh/authorized_keys /home/lianghua/.ssh/
sudo chown -R lianghua:lianghua /home/lianghua/.ssh
sudo chmod 700 /home/lianghua/.ssh
sudo chmod 600 /home/lianghua/.ssh/authorized_keys
```

### 3. 安全配置

```bash
# 配置防火墙
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw allow 5000  # 开发环境

# 配置fail2ban
sudo apt install -y fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban

# 禁用root登录
sudo vim /etc/ssh/sshd_config
# 设置: PermitRootLogin no
sudo systemctl restart sshd
```

### 4. 部署应用

```bash
# 切换到应用用户
su - lianghua

# 克隆代码
git clone https://github.com/your-repo/lianghua_vn.git
cd lianghua_vn

# 使用Docker部署
docker-compose up -d

# 或使用传统方式部署
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 5. 域名和SSL配置

```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加: 0 2 * * * certbot renew --quiet
```

## 🏗️ 生产环境部署

### 1. 高可用架构

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  app1:
    build: .
    environment:
      - DATABASE_URL=mysql://lianghua:password@mysql-master:3306/lianghua_trading
      - REDIS_URL=redis://:password@redis-master:6379/0
    restart: always

  app2:
    build: .
    environment:
      - DATABASE_URL=mysql://lianghua:password@mysql-master:3306/lianghua_trading
      - REDIS_URL=redis://:password@redis-master:6379/0
    restart: always

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/prod.conf:/etc/nginx/nginx.conf
    depends_on:
      - app1
      - app2
    restart: always

  mysql-master:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=strong_password
      - MYSQL_REPLICATION_MODE=master
    volumes:
      - mysql_master_data:/var/lib/mysql
    restart: always

  mysql-slave:
    image: mysql:8.0
    environment:
      - MYSQL_REPLICATION_MODE=slave
      - MYSQL_MASTER_HOST=mysql-master
    volumes:
      - mysql_slave_data:/var/lib/mysql
    restart: always

  redis-master:
    image: redis:7-alpine
    command: redis-server --requirepass strong_password
    volumes:
      - redis_master_data:/data
    restart: always

  redis-slave:
    image: redis:7-alpine
    command: redis-server --slaveof redis-master 6379 --requirepass strong_password
    volumes:
      - redis_slave_data:/data
    restart: always

volumes:
  mysql_master_data:
  mysql_slave_data:
  redis_master_data:
  redis_slave_data:
```

### 2. 负载均衡配置

```nginx
# nginx/prod.conf
upstream app_servers {
    least_conn;
    server app1:5000 weight=1 max_fails=3 fail_timeout=30s;
    server app2:5000 weight=1 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL配置
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;

    # 安全头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;

    location / {
        proxy_pass http://app_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 健康检查
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_timeout 0;
        proxy_next_upstream_tries 3;
    }
}
```

### 3. 监控配置

```yaml
# monitoring/docker-compose.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    restart: always

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin_password
    volumes:
      - grafana_data:/var/lib/grafana
    restart: always

  node-exporter:
    image: prom/node-exporter
    ports:
      - "9100:9100"
    restart: always

volumes:
  prometheus_data:
  grafana_data:
```

### 4. 备份策略

```bash
#!/bin/bash
# scripts/backup.sh

# 数据库备份
mysqldump -h mysql-master -u lianghua -p lianghua_trading > backup/db_$(date +%Y%m%d_%H%M%S).sql

# Redis备份
redis-cli -h redis-master -a password --rdb backup/redis_$(date +%Y%m%d_%H%M%S).rdb

# 代码备份
tar -czf backup/code_$(date +%Y%m%d_%H%M%S).tar.gz /app

# 上传到云存储
aws s3 cp backup/ s3://your-backup-bucket/ --recursive

# 清理旧备份
find backup/ -name "*.sql" -mtime +7 -delete
find backup/ -name "*.rdb" -mtime +7 -delete
find backup/ -name "*.tar.gz" -mtime +7 -delete
```

## 🔧 部署脚本

### 1. 自动化部署脚本

```bash
#!/bin/bash
# deploy.sh

set -e

# 配置变量
APP_NAME="lianghua_vn"
DEPLOY_USER="lianghua"
DEPLOY_HOST="your-server.com"
DEPLOY_PATH="/opt/lianghua_vn"
BACKUP_PATH="/opt/backup"

echo "开始部署 $APP_NAME..."

# 备份当前版本
ssh $DEPLOY_USER@$DEPLOY_HOST "
    if [ -d $DEPLOY_PATH ]; then
        sudo cp -r $DEPLOY_PATH $BACKUP_PATH/$(date +%Y%m%d_%H%M%S)
    fi
"

# 上传新版本
rsync -avz --exclude='.git' --exclude='venv' --exclude='*.pyc' \
    ./ $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/

# 部署新版本
ssh $DEPLOY_USER@$DEPLOY_HOST "
    cd $DEPLOY_PATH
    
    # 停止服务
    docker-compose down
    
    # 更新依赖
    docker-compose build
    
    # 启动服务
    docker-compose up -d
    
    # 健康检查
    sleep 30
    curl -f http://localhost:5000/health || exit 1
"

echo "部署完成！"
```

### 2. 滚动部署脚本

```bash
#!/bin/bash
# rolling_deploy.sh

# 滚动更新，零停机部署
for service in app1 app2; do
    echo "更新服务: $service"
    
    # 停止一个实例
    docker-compose stop $service
    
    # 重新构建
    docker-compose build $service
    
    # 启动实例
    docker-compose up -d $service
    
    # 健康检查
    sleep 30
    curl -f http://localhost:5000/health || exit 1
    
    echo "服务 $service 更新完成"
done
```

## ✅ 部署验证

### 1. 功能验证

```bash
# 基本功能测试
curl -f http://localhost:5000/health
curl -f http://localhost:5000/api/dashboard/summary

# 数据库连接测试
python -c "
from data.database import get_database_manager
db = get_database_manager()
print('数据库连接成功' if db else '数据库连接失败')
"

# Redis连接测试
redis-cli ping

# WebSocket测试
python -c "
import websocket
ws = websocket.create_connection('ws://localhost:5000/ws')
print('WebSocket连接成功')
ws.close()
"
```

### 2. 性能测试

```bash
# 安装压测工具
sudo apt install -y apache2-utils

# API压测
ab -n 1000 -c 10 http://localhost:5000/api/dashboard/summary

# 并发连接测试
for i in {1..50}; do
    curl http://localhost:5000/health &
done
wait
```

### 3. 监控验证

```bash
# 检查系统资源
htop
iotop
nethogs

# 检查日志
tail -f logs/app.log
docker-compose logs -f app

# 检查服务状态
systemctl status nginx
docker-compose ps
```

## 🚨 故障排除

### 常见问题

1. **端口占用**
```bash
# 检查端口占用
netstat -tlnp | grep :5000
lsof -i :5000

# 杀死占用进程
sudo kill -9 <pid>
```

2. **权限问题**
```bash
# 检查文件权限
ls -la
chmod +x run_monitor.py
chown -R lianghua:lianghua /opt/lianghua_vn
```

3. **依赖缺失**
```bash
# 重新安装依赖
pip install --upgrade -r requirements.txt

# 检查Python版本
python --version
```

4. **数据库连接失败**
```bash
# 检查数据库状态
systemctl status mysql
mysql -u lianghua -p -e "SELECT 1"

# 检查防火墙
sudo ufw status
```

### 日志分析

```bash
# 查看应用日志
tail -f logs/app.log | grep ERROR

# 查看系统日志
journalctl -u lianghua_vn -f

# 查看Nginx日志
tail -f /var/log/nginx/error.log
```

## 📚 最佳实践

### 1. 安全最佳实践

- 定期更新系统和依赖包
- 使用强密码和密钥认证
- 配置防火墙和入侵检测
- 定期备份数据
- 监控系统安全日志

### 2. 性能最佳实践

- 使用SSD存储
- 配置数据库索引
- 启用Redis缓存
- 使用CDN加速静态资源
- 配置负载均衡

### 3. 运维最佳实践

- 自动化部署流程
- 配置监控告警
- 建立应急响应流程
- 定期进行故障演练
- 维护详细的操作文档

---

**文档版本**: v1.0  
**最后更新**: 2025年8月18日  
**维护团队**: 运维团队